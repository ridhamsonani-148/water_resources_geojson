version: 0.2

phases:
  install:
    runtime-versions:
      nodejs: 20
      python: 3.9
    commands:
      - npm install -g aws-cdk@2.140.0
      - npm install
      - pip install -r requirements.txt
  build:
    commands:
      - npm run build
      - cdk synth
      - |
        if [ "$ACTION" = "destroy" ]; then
          echo "Destroying CDK stack...";
          cdk destroy GeoReferencePipelineStack --force \
            --parameters BucketName="$BUCKET_NAME" \
            --parameters ErrorFolder="$ERROR_FOLDER" \
            --parameters AnalysisFolder="$ANALYSIS_FOLDER" \
            --parameters GithubToken="$GITHUB_TOKEN" \
            --parameters GithubRepoName="$GITHUB_REPO_NAME" \
            --parameters BedrockModelId="$BEDROCK_MODEL_ID" \
            --parameters BedrockRegion="$BEDROCK_REGION";
        else
          echo "Deploying CDK stack...";
          cdk deploy GeoReferencePipelineStack --require-approval never \
            --parameters BucketName="$BUCKET_NAME" \
            --parameters ErrorFolder="$ERROR_FOLDER" \
            --parameters AnalysisFolder="$ANALYSIS_FOLDER" \
            --parameters GithubToken="$GITHUB_TOKEN" \
            --parameters GithubRepoName="$GITHUB_REPO_NAME" \
            --parameters BedrockModelId="$BEDROCK_MODEL_ID" \
            --parameters BedrockRegion="$BEDROCK_REGION";
        fi
artifacts:
  files:
    - '**/*'
  base-directory: 'cdk.out'